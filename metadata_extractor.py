import sys
import os
import time
from PIL import Image
from PIL.ExifTags import TAGS
from pymediainfo import MediaInfo
# Import statements with fallback compatibility
try:
    from pypdf import PdfReader
except ImportError:
    try:
        from PyPDF2 import PdfReader
    except ImportError:
        print("Error: Please install pypdf or PyPDF2: pip install pypdf")
        sys.exit(1)

# ANSI color codes for terminal styling
class Colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKCYAN = '\033[96m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'
    PURPLE = '\033[35m'
    YELLOW = '\033[33m'
    BLUE = '\033[34m'
    RED = '\033[31m'
    GREEN = '\033[32m'
    CYAN = '\033[36m'
    WHITE = '\033[37m'

# Terminal interface utilities
class TerminalUI:
    @staticmethod
    def clear_screen():
        os.system('cls' if os.name == 'nt' else 'clear')
    
    @staticmethod
    def print_separator(char="‚ïê", length=80, color=Colors.OKCYAN):
        print(f"{color}{char * length}{Colors.ENDC}")
    
    @staticmethod
    def print_box(text, color=Colors.OKBLUE, padding=2):
        lines = text.split('\n')
        max_length = max(len(line) for line in lines)
        width = max_length + (padding * 2)
        
        print(f"{color}‚ïî{'‚ïê' * width}‚ïó{Colors.ENDC}")
        for line in lines:
            spaces = ' ' * (max_length - len(line))
            print(f"{color}‚ïë{' ' * padding}{line}{spaces}{' ' * padding}‚ïë{Colors.ENDC}")
        print(f"{color}‚ïö{'‚ïê' * width}‚ïù{Colors.ENDC}")
    
    @staticmethod
    def loading_animation(text, duration=2.0):
        frames = ['‚†ã', '‚†ô', '‚†π', '‚†∏', '‚†º', '‚†¥', '‚†¶', '‚†ß', '‚†á', '‚†è']
        start_time = time.time()
        i = 0
        while time.time() - start_time < duration:
            print(f"\r{Colors.OKCYAN}{frames[i % len(frames)]} {text}{Colors.ENDC}", end='', flush=True)
            time.sleep(0.1)
            i += 1
        print(f"\r{Colors.OKGREEN}‚úì {text} - Complete!{Colors.ENDC}")

def print_banner():
    TerminalUI.clear_screen()
    banner = f"""
{Colors.OKCYAN}
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  
‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  
‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
{Colors.ENDC}
    """
    print(banner)
    
    # Animated welcome message
    welcome_text = f"{Colors.BOLD}{Colors.PURPLE}Welcome to FllameTape - File Metadata Extractor!{Colors.ENDC}"
    author_text = f"{Colors.CYAN}Created by kiwuauaa - Digital Forensics Specialist{Colors.ENDC}"
    
    TerminalUI.print_box(f"{welcome_text}\n{author_text}", Colors.PURPLE)
    
    print(f"\n{Colors.YELLOW}üîç Discover hidden metadata in your files{Colors.ENDC}")
    print(f"{Colors.GREEN}üìä Professional forensics tool for data analysis{Colors.ENDC}")
    
    TerminalUI.print_separator("‚îÄ", 80, Colors.OKCYAN)
    print()

def print_command_headers():
    """Print custom headers for each command type"""
    pass

def print_image_header():
    print(f"\n{Colors.PURPLE}{'‚ïê' * 80}{Colors.ENDC}")
    print(f"{Colors.BOLD}{Colors.CYAN}üì∑ IMAGE METADATA EXTRACTION MODE{Colors.ENDC}")
    print(f"{Colors.PURPLE}{'‚ïê' * 80}{Colors.ENDC}")
    print(f"{Colors.YELLOW}üîç Extracting EXIF data from image files{Colors.ENDC}")
    print(f"{Colors.GREEN}üìä Supported formats: JPEG, PNG, TIFF, and more{Colors.ENDC}\n")

def print_media_header():
    print(f"\n{Colors.BLUE}{'‚ïê' * 80}{Colors.ENDC}")
    print(f"{Colors.BOLD}{Colors.CYAN}üéµ MEDIA METADATA EXTRACTION MODE{Colors.ENDC}")
    print(f"{Colors.BLUE}{'‚ïê' * 80}{Colors.ENDC}")
    print(f"{Colors.YELLOW}üîç Extracting metadata from audio/video files{Colors.ENDC}")
    print(f"{Colors.GREEN}üìä Supported: MP3, MP4, AVI, MKV, FLAC, and more{Colors.ENDC}\n")

def print_pdf_header():
    print(f"\n{Colors.RED}{'‚ïê' * 80}{Colors.ENDC}")
    print(f"{Colors.BOLD}{Colors.CYAN}üìÑ PDF METADATA EXTRACTION MODE{Colors.ENDC}")
    print(f"{Colors.RED}{'‚ïê' * 80}{Colors.ENDC}")
    print(f"{Colors.YELLOW}üîç Extracting document information from PDF files{Colors.ENDC}")
    print(f"{Colors.GREEN}üìä Document properties, author info, and more{Colors.ENDC}\n")

def extract_image_metadata(file_path):
    print_image_header()
    
    # Animated processing message
    TerminalUI.loading_animation(f"Processing image: {os.path.basename(file_path)}", 1.5)
    
    try:
        image = Image.open(file_path)
        # Use the modern getexif() method instead of deprecated _getexif()
        exif_data = image.getexif()
        
        if not exif_data:
            TerminalUI.print_box(f"‚ö†Ô∏è  No EXIF metadata found\nFile: {os.path.basename(file_path)}", Colors.WARNING)
            return

        # Success header
        print(f"\n{Colors.OKGREEN}‚úÖ EXIF METADATA SUCCESSFULLY EXTRACTED{Colors.ENDC}")
        TerminalUI.print_separator("‚îÄ", 60, Colors.OKGREEN)
        
        print(f"{Colors.BOLD}{Colors.CYAN}üì∏ Image Information:{Colors.ENDC}")
        print(f"{Colors.YELLOW}   üìÅ File: {os.path.basename(file_path)}{Colors.ENDC}")
        print(f"{Colors.YELLOW}   üìê Format: {image.format}{Colors.ENDC}")
        print(f"{Colors.YELLOW}   üìè Size: {image.size[0]} x {image.size[1]} pixels{Colors.ENDC}")
        print(f"{Colors.YELLOW}   üé® Mode: {image.mode}{Colors.ENDC}\n")
        
        print(f"{Colors.BOLD}{Colors.PURPLE}üìä EXIF Metadata Details:{Colors.ENDC}")
        TerminalUI.print_separator("‚îÄ", 60, Colors.PURPLE)
        
        for tag_id, value in exif_data.items():
            tag = TAGS.get(tag_id, tag_id)
            # Handle binary data and long strings
            if isinstance(value, bytes):
                try:
                    value = value.decode('utf-8', errors='ignore')
                except:
                    value = str(value)
            elif isinstance(value, str) and len(value) > 100:
                value = value[:100] + "..."
            
            print(f"{Colors.CYAN}   üî∏ {tag}: {Colors.WHITE}{value}{Colors.ENDC}")
            
    except FileNotFoundError:
        TerminalUI.print_box(f"‚ùå File not found\nPath: {file_path}", Colors.FAIL)
    except Exception as e:
        TerminalUI.print_box(f"‚ùå Error processing image\nError: {str(e)}", Colors.FAIL)

def extract_media_metadata(file_path):
    print_media_header()
    
    # Animated processing message
    TerminalUI.loading_animation(f"Analyzing media file: {os.path.basename(file_path)}", 1.5)
    
    try:
        media_info = MediaInfo.parse(file_path)
        if not media_info.tracks:
            TerminalUI.print_box(f"‚ö†Ô∏è  No media metadata found\nFile: {os.path.basename(file_path)}", Colors.WARNING)
            return

        # Success header
        print(f"\n{Colors.OKGREEN}‚úÖ MEDIA METADATA SUCCESSFULLY EXTRACTED{Colors.ENDC}")
        TerminalUI.print_separator("‚îÄ", 60, Colors.OKGREEN)
        
        print(f"{Colors.BOLD}{Colors.CYAN}üéµ Media File Information:{Colors.ENDC}")
        print(f"{Colors.YELLOW}   üìÅ File: {os.path.basename(file_path)}{Colors.ENDC}")
        print(f"{Colors.YELLOW}   üìä Total tracks: {len(media_info.tracks)}{Colors.ENDC}\n")
        
        track_icons = {
            'General': 'üìã',
            'Video': 'üé¨',
            'Audio': 'üéµ',
            'Text': 'üìù',
            'Menu': 'üìö'
        }
        
        for i, track in enumerate(media_info.tracks, 1):
            track_type = track.track_type
            icon = track_icons.get(track_type, 'üìÑ')
            
            print(f"{Colors.BOLD}{Colors.PURPLE}{icon} Track {i}: {track_type.upper()}{Colors.ENDC}")
            TerminalUI.print_separator("‚îÄ", 50, Colors.PURPLE)
            
            track_data = track.to_data()
            for key, value in track_data.items():
                if value and key != 'track_type':
                    # Handle long values
                    if isinstance(value, str) and len(value) > 100:
                        value = value[:100] + "..."
                    print(f"{Colors.CYAN}   üî∏ {key}: {Colors.WHITE}{value}{Colors.ENDC}")
            print()
            
    except FileNotFoundError:
        TerminalUI.print_box(f"‚ùå File not found\nPath: {file_path}", Colors.FAIL)
    except Exception as e:
        TerminalUI.print_box(f"‚ùå Error processing media file\nError: {str(e)}", Colors.FAIL)

def extract_pdf_metadata(file_path):
    print_pdf_header()
    
    # Animated processing message
    TerminalUI.loading_animation(f"Reading PDF document: {os.path.basename(file_path)}", 1.5)
    
    try:
        with open(file_path, 'rb') as f:
            reader = PdfReader(f)
            info = reader.metadata
            
            # Success header
            print(f"\n{Colors.OKGREEN}‚úÖ PDF METADATA SUCCESSFULLY EXTRACTED{Colors.ENDC}")
            TerminalUI.print_separator("‚îÄ", 60, Colors.OKGREEN)
            
            print(f"{Colors.BOLD}{Colors.CYAN}üìÑ Document Information:{Colors.ENDC}")
            print(f"{Colors.YELLOW}   üìÅ File: {os.path.basename(file_path)}{Colors.ENDC}")
            print(f"{Colors.YELLOW}   üìä Total pages: {len(reader.pages)}{Colors.ENDC}")
            print(f"{Colors.YELLOW}   üîê Encrypted: {'Yes' if reader.is_encrypted else 'No'}{Colors.ENDC}\n")
            
            if info:
                print(f"{Colors.BOLD}{Colors.PURPLE}üìã Document Metadata:{Colors.ENDC}")
                TerminalUI.print_separator("‚îÄ", 60, Colors.PURPLE)
                
                for key, value in info.items():
                    # Clean up the key name (remove leading slash)
                    clean_key = key.lstrip('/')
                    # Handle different value types
                    if hasattr(value, 'strip'):
                        value = value.strip()
                    print(f"{Colors.CYAN}   üî∏ {clean_key}: {Colors.WHITE}{value}{Colors.ENDC}")
            else:
                TerminalUI.print_box(f"‚ö†Ô∏è  No document metadata found\nFile: {os.path.basename(file_path)}", Colors.WARNING)
                
    except FileNotFoundError:
        TerminalUI.print_box(f"‚ùå File not found\nPath: {file_path}", Colors.FAIL)
    except Exception as e:
        TerminalUI.print_box(f"‚ùå Error processing PDF document\nError: {str(e)}", Colors.FAIL)

def display_menu():
    print(f"{Colors.BOLD}{Colors.HEADER}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó{Colors.ENDC}")
    print(f"{Colors.BOLD}{Colors.HEADER}‚ïë                          üîß METADATA EXTRACTION MENU                        ‚ïë{Colors.ENDC}")
    print(f"{Colors.BOLD}{Colors.HEADER}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù{Colors.ENDC}")
    print(f"{Colors.BOLD}\nSelect the type of file you want to analyze:{Colors.ENDC}\n")
    
    print(f"{Colors.BOLD}{Colors.PURPLE}  üì∑ [1] Image Files{Colors.ENDC}")
    print(f"{Colors.CYAN}      ‚îî‚îÄ Extract EXIF metadata from photos{Colors.ENDC}")
    print(f"{Colors.CYAN}      ‚îî‚îÄ Formats: JPEG, PNG, TIFF, etc.{Colors.ENDC}\n")
    
    print(f"{Colors.BOLD}{Colors.BLUE}  üéµ [2] Audio/Video Files{Colors.ENDC}")
    print(f"{Colors.CYAN}      ‚îî‚îÄ Extract MediaInfo and ID3 tags{Colors.ENDC}")
    print(f"{Colors.CYAN}      ‚îî‚îÄ Formats: MP3, MP4, AVI, MKV, etc.{Colors.ENDC}\n")
    
    print(f"{Colors.BOLD}{Colors.RED}  üìÑ [3] PDF Documents{Colors.ENDC}")
    print(f"{Colors.CYAN}      ‚îî‚îÄ Extract document properties{Colors.ENDC}")
    print(f"{Colors.CYAN}      ‚îî‚îÄ Author, creation date, etc.{Colors.ENDC}\n")
    
    print(f"{Colors.BOLD}{Colors.WARNING}  üö™ [4] Exit Program{Colors.ENDC}")
    print(f"{Colors.CYAN}      ‚îî‚îÄ Close FllameTape safely{Colors.ENDC}\n")
    
    TerminalUI.print_separator("‚îÄ", 80, Colors.OKCYAN)

def main():
    print_banner()

    while True:
        display_menu()
        choice = input("Enter your choice (1-4): ").strip()
        if choice == '4':
            print(f"\n{Colors.PURPLE}{'‚ïê' * 80}{Colors.ENDC}")
            print(f"{Colors.BOLD}{Colors.CYAN}üëã Thank you for using FllameTape!{Colors.ENDC}")
            print(f"{Colors.PURPLE}{'‚ïê' * 80}{Colors.ENDC}")
            print(f"{Colors.YELLOW}üîç Tool created by kiwuauaa{Colors.ENDC}")
            print(f"{Colors.GREEN}üåü Perfect for digital forensics and data analysis{Colors.ENDC}")
            print(f"{Colors.CYAN}üí° Visit: https://github.com/kiwuauaa/FllameTape{Colors.ENDC}")
            print(f"{Colors.PURPLE}{'‚ïê' * 80}{Colors.ENDC}")
            print(f"{Colors.BOLD}{Colors.OKCYAN}Goodbye! üöÄ{Colors.ENDC}\n")
            break
        elif choice in ['1', '2', '3']:
            file_path = input("Enter the path to your file: ").strip()
            if not os.path.isfile(file_path):
                print(f"{Colors.FAIL}File not found. Please try again.{Colors.ENDC}\n")
                continue

            if choice == '1':
                extract_image_metadata(file_path)
            elif choice == '2':
                extract_media_metadata(file_path)
            elif choice == '3':
                extract_pdf_metadata(file_path)
            # Results footer
            print(f"\n{Colors.OKGREEN}{'‚ïê' * 80}{Colors.ENDC}")
            print(f"{Colors.BOLD}{Colors.GREEN}‚ú® Metadata extraction completed successfully!{Colors.ENDC}")
            print(f"{Colors.CYAN}üìä Analysis by FllameTape - Created by kiwuauaa{Colors.ENDC}")
            print(f"{Colors.OKGREEN}{'‚ïê' * 80}{Colors.ENDC}\n")
            
            input(f"{Colors.YELLOW}Press Enter to continue...{Colors.ENDC}")
        else:
            print(f"{Colors.WARNING}Invalid choice. Please enter a number between 1 and 4.{Colors.ENDC}\n")

if __name__ == '__main__':
    main()

